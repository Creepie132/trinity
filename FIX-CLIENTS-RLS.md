# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ RLS –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤

## –ü—Ä–æ–±–ª–µ–º–∞
–ù–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/clients` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è "–ö–ª–∏–µ–Ω—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", —Ö–æ—Ç—è –≤ Supabase –¥–∞–Ω–Ω—ã–µ –µ—Å—Ç—å.

**–ü—Ä–∏—á–∏–Ω–∞:** RLS –ø–æ–ª–∏—Ç–∏–∫–∞ –±–ª–æ–∫–∏—Ä—É–µ—Ç SELECT –∑–∞–ø—Ä–æ—Å—ã.

---

## –†–µ—à–µ–Ω–∏–µ

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç—å RLS –≤ Supabase

1. –û—Ç–∫—Ä–æ–π **Supabase Dashboard** ‚Üí —Ç–≤–æ–π –ø—Ä–æ–µ–∫—Ç
2. –ü–µ—Ä–µ–π–¥–∏ –≤ **SQL Editor**
3. –í—Å—Ç–∞–≤—å SQL –∏–∑ —Ñ–∞–π–ª–∞ `fix-clients-rls-select.sql`
4. –ù–∞–∂–º–∏ **Run** (–∏–ª–∏ `Ctrl+Enter`)

–ü–æ–ª–∏—Ç–∏–∫–∞ —Ä–∞–∑—Ä–µ—à–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º —á–∏—Ç–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–æ–≤ —Ç–æ–ª—å–∫–æ –∏—Ö –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏.

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏

1. –û—Ç–∫—Ä–æ–π —Å–∞–π—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ
2. –û—Ç–∫—Ä–æ–π **DevTools** (F12)
3. –ü–µ—Ä–µ–π–¥–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É **Console**
4. –ó–∞–π–¥–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É `/clients`
5. –£–≤–∏–¥–∏—à—å:
   ```
   Clients query result: { data: [...], error: null, count: 5, orgId: "xxx" }
   ```

–ï—Å–ª–∏ `data: []` –∏ `error: null` ‚Üí RLS –≤—Å—ë –µ—â—ë –±–ª–æ–∫–∏—Ä—É–µ—Ç.  
–ï—Å–ª–∏ `data: [...]` ‚Üí –≤—Å—ë —Ä–∞–±–æ—Ç–∞–µ—Ç! üéâ

---

## –î–µ–ø–ª–æ–π –Ω–∞ Vercel

```bash
cd trinity
git add .
git commit -m "fix: add RLS SELECT policy and debug logging for clients"
git push origin main
```

Vercel –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–¥–µ–ø–ª–æ–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ ~1-2 –º–∏–Ω—É—Ç—ã.

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ª–∏—Ç–∏–∫ –≤ Supabase

–ó–∞–ø—É—Å—Ç–∏ –≤ SQL Editor:

```sql
SELECT 
  schemaname,
  tablename,
  policyname,
  cmd,
  qual
FROM pg_policies 
WHERE tablename = 'clients';
```

–î–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–∏—Ç–∏–∫–∞:
- **Name:** `Users can select clients for their org`
- **Command:** `SELECT`
- **USING:** `(org_id IN (SELECT org_id FROM org_users WHERE user_id = auth.uid()))`

---

## –ï—Å–ª–∏ –Ω–µ –ø–æ–º–æ–≥–ª–æ

1. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –µ—Å—Ç—å –≤ —Ç–∞–±–ª–∏—Ü–µ `org_users`:
   ```sql
   SELECT * FROM org_users WHERE user_id = auth.uid();
   ```

2. –ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ –∫–ª–∏–µ–Ω—Ç—ã –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∞—Ç —Ç–æ–π –∂–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏:
   ```sql
   SELECT c.id, c.first_name, c.last_name, c.org_id
   FROM clients c
   JOIN org_users ou ON c.org_id = ou.org_id
   WHERE ou.user_id = auth.uid();
   ```

3. –ï—Å–ª–∏ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø—É—Å—Ç–æ ‚Üí –Ω–∞–ø–∏—à–∏ –º–Ω–µ, –ø—Ä–æ–¥–æ–ª–∂–∏–º —Ä–∞–∑–±–∏—Ä–∞—Ç—å—Å—è.

---

## ‚ö†Ô∏è –í–∞–∂–Ω–æ –ø—Ä–æ —Ç–æ–∫–µ–Ω

**GitHub —Ç–æ–∫–µ–Ω—ã –Ω–µ–ª—å–∑—è –ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –≤ —á–∞—Ç–∞—Ö, –∫–æ–¥–µ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏!**

–ï—Å–ª–∏ —Ç—ã —Å–ª—É—á–∞–π–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–ª —Ç–æ–∫–µ–Ω:
1. –ó–∞–π–¥–∏: https://github.com/settings/tokens
2. –ù–∞–π–¥–∏ —Ç–æ–∫–µ–Ω (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å `ghp_...`)
3. –ù–∞–∂–º–∏ **Delete** / **Revoke**
4. –°–æ–∑–¥–∞–π –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω (Settings ‚Üí Developer settings ‚Üí Personal access tokens)
5. –°–æ—Ö—Ä–∞–Ω–∏ –µ–≥–æ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ (–Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–π –Ω–∏–∫–æ–º—É!)

–¢–æ–∫–µ–Ω –¥–∞—ë—Ç –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Ç–≤–æ–∏–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è–º. –ë–µ—Ä–µ–≥–∏ –µ–≥–æ –∫–∞–∫ –ø–∞—Ä–æ–ª—å.
