# Trinity Module Access Control Implementation

## –ó–∞–¥–∞—á–∞ (Trinity –≤ Clientbase-pro)

–ö–æ–≥–¥–∞ –≤ –º–æ–¥–∞–ª–∫–µ "–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞" –≤–∫–ª—é—á–∞—é –∏–ª–∏ –æ—Ç–∫–ª—é—á–∞—é –º–æ–¥—É–ª—å:

1. ‚úÖ –û–±–Ω–æ–≤–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É subscriptions ‚Äî —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –º–æ–¥—É–ª–µ–π
2. ‚úÖ –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —ç—Ç–æ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ (owner + staff) –¥–æ–ª–∂–Ω—ã —Ç–µ—Ä—è—Ç—å –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–æ–¥—É–ª—é –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
3. ‚úÖ –ï—Å–ª–∏ –º–æ–¥—É–ª—å –æ—Ç–∫–ª—é—á—ë–Ω:
   - –°–∫—Ä—ã—Ç—å —Ä–∞–∑–¥–µ–ª –≤ —Å–∞–π–¥–±–∞—Ä–µ —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
   - –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∑–∞–π—Ç–∏ –ø–æ –ø—Ä—è–º–æ–π —Å—Å—ã–ª–∫–µ ‚Äî —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ /dashboard
   - –ü—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ middleware –∏–ª–∏ RLS –ø–æ–ª–∏—Ç–∏–∫—É –≤ Supabase

**–°—Ç–µ–∫:** Next.js 14, Supabase, TypeScript, middleware.ts

**–Ø–∑—ã–∫–∏:** –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –≤—Å–µ—Ö —è–∑—ã–∫–∞—Ö —Å–∏—Å—Ç–µ–º—ã (—Ä—É—Å—Å–∫–∏–π, –∏–≤—Ä–∏—Ç)

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### 1. Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (`src/hooks/useOrganization.ts`)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ Supabase Realtime –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `organizations`
- –ü—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ `features` –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç—Å—è –∫—ç—à React Query
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –æ—Ç–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ –º–æ–¥—É–ª—è, –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/dashboard`

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
```typescript
// –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏
const channel = supabase
  .channel(`organization:${orgId}`)
  .on('postgres_changes', {
    event: 'UPDATE',
    schema: 'public',
    table: 'organizations',
    filter: `id=eq.${orgId}`,
  }, (payload) => {
    // –ò–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫—ç—à–∞
    queryClient.invalidateQueries({ queryKey: ['organization'] })
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–µ–∫—É—â–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ
    const newModules = payload.new.features?.modules || {}
    if (currentPath.startsWith('/payments') && !newModules.payments) {
      router.push('/dashboard')
    }
  })
  .subscribe()
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- üü¢ –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–ª—É—á–∞—é—Ç –æ–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- üü¢ –°–∞–π–¥–±–∞—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- üü¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü

---

### 2. Middleware –∑–∞—â–∏—Ç–∞ (`middleware.ts`)

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –º–æ–¥—É–ª–µ–π –Ω–∞ —É—Ä–æ–≤–Ω–µ middleware –¥–ª—è –∑–∞—â–∏—Ç—ã —Ä–æ—É—Ç–æ–≤
- –ú–∞–ø–ø–∏–Ω–≥ —Ä–æ—É—Ç–æ–≤ –∫ –º–æ–¥—É–ª—è–º:
  ```typescript
  const moduleRoutes = {
    '/payments': 'payments',
    '/inventory': 'inventory',
    '/sms': 'sms',
    '/stats': 'statistics',
    '/reports': 'reports',
    '/subscriptions': 'subscriptions',
    '/booking': 'booking',
    '/loyalty': 'loyalty',
  }
  ```

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç:**
- Middleware –∑–∞–≥—Ä—É–∂–∞–µ—Ç `organizations(subscription_status, subscription_expires_at, features)` –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø –∫ –º–æ–¥—É–ª—é —á–µ—Ä–µ–∑ `features.modules[moduleKey]`
- –ï—Å–ª–∏ –º–æ–¥—É–ª—å –æ—Ç–∫–ª—é—á—ë–Ω, —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `/dashboard`

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- üü¢ –ó–∞—â–∏—Ç–∞ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞
- üü¢ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –æ–±–æ–π—Ç–∏ —á–µ—Ä–µ–∑ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É
- üü¢ –†–∞–±–æ—Ç–∞–µ—Ç –¥–∞–∂–µ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø—ã—Ç–∞–µ—Ç—Å—è –∑–∞–π—Ç–∏ —á–µ—Ä–µ–∑ –∑–∞–∫–ª–∞–¥–∫–∏/–∏—Å—Ç–æ—Ä–∏—é

---

### 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Sidebar –∏ MobileSidebar

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –û–±–Ω–æ–≤–ª–µ–Ω—ã –æ–±–∞ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –ø–æ –º–æ–¥—É–ª—è–º
- –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω –ø–æ–¥—Ö–æ–¥ —á–µ—Ä–µ–∑ `useFeatures` hook
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ "–≤—Å–µ–≥–¥–∞ –≤–∏–¥–∏–º—ã—Ö" –º–æ–¥—É–ª–µ–π (clients, visits, diary)

**–ú–∞–ø–ø–∏–Ω–≥ –º–æ–¥—É–ª–µ–π:**
```typescript
const featureMap = {
  'clients': features.hasClients,
  'visits': features.hasVisits,
  'payments': features.hasPayments,
  'inventory': features.hasInventory,
  'diary': true, // Always visible
  'sms': features.hasSms,
  'statistics': features.hasStatistics,
  'reports': features.hasReports,
  'subscriptions': features.hasSubscriptions,
  'booking': features.hasBooking,
  'telegram': features.hasTelegram,
  'loyalty': features.hasLoyalty,
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- üü¢ –°–∞–π–¥–±–∞—Ä –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–æ–¥—É–ª–∏
- üü¢ –ë–∞–∑–æ–≤—ã–µ –º–æ–¥—É–ª–∏ (clients, visits, diary) –≤—Å–µ–≥–¥–∞ –≤–∏–¥–Ω—ã
- üü¢ –û–¥–∏–Ω–∞–∫–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –Ω–∞ desktop –∏ mobile

---

### 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ useFeatures hook

**–ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ:**
- –ò–∑–º–µ–Ω–µ–Ω—ã –¥–µ—Ñ–æ–ª—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö –º–æ–¥—É–ª–µ–π —Å `true` –Ω–∞ `false`
- –ú–æ–¥—É–ª–∏ —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —è–≤–Ω–æ–º –≤–∫–ª—é—á–µ–Ω–∏–∏
- –ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –º–æ–¥—É–ª–∏ —Å —Ñ–ª–∞–≥–æ–º `alwaysVisible` (clients, visits, diary)

**–õ–æ–≥–∏–∫–∞:**
```typescript
// Always visible modules (clients, visits, diary)
hasClients: modules.clients ?? true,
hasVisits: modules.visits ?? true,

// Optional modules (default to false unless explicitly enabled)
hasPayments: modules.payments ?? false,
hasInventory: modules.inventory ?? false,
hasSms: modules.sms ?? false,
// –∏ —Ç.–¥.
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- üü¢ –ú–æ–¥—É–ª–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
- üü¢ –ê–¥–º–∏–Ω—ã –≤–∏–¥—è—Ç –≤—Å—ë (–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏)
- üü¢ –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –ø–æ–¥—Ö–æ–¥: –¥–æ—Å—Ç—É–ø –¥–∞—ë—Ç—Å—è —è–≤–Ω–æ, –∞ –Ω–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é

---

## –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### –¢–µ—Å—Ç 1: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∏—Å—Ç–µ–º—É **–≤ –¥–≤—É—Ö –±—Ä–∞—É–∑–µ—Ä–∞—Ö/–æ–∫–Ω–∞—Ö**:
   - –û–∫–Ω–æ –ê: –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å ‚Üí –ü–æ–¥–ø–∏—Å–∫–∏ ‚Üí "–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞"
   - –û–∫–Ω–æ –ë: –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ç–æ–π –∂–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ `/payments`

2. –í –æ–∫–Ω–µ –ê –æ—Ç–∫–ª—é—á–∏—Ç–µ –º–æ–¥—É–ª—å "–ü–ª–∞—Ç–µ–∂–∏" (payments)

3. **–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ –æ–∫–Ω–µ –ë:**
   - ‚úÖ –°–∞–π–¥–±–∞—Ä –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, —Ä–∞–∑–¥–µ–ª "–ü–ª–∞—Ç–µ–∂–∏" –∏—Å—á–µ–∑–∞–µ—Ç
   - ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ `/dashboard`

### –¢–µ—Å—Ç 2: –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ—Ç–∫–ª—é—á—ë–Ω–Ω—ã–π –º–æ–¥—É–ª—å

1. –û—Ç–∫–ª—é—á–∏—Ç–µ –º–æ–¥—É–ª—å "–°–∫–ª–∞–¥" (inventory) –≤ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É: `https://yourdomain.com/inventory`
3. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–π—Ç–∏ –ø–æ —ç—Ç–æ–π —Å—Å—ã–ª–∫–µ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ Middleware —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `/dashboard`
- ‚úÖ –í –∫–æ–Ω—Å–æ–ª–∏ –ª–æ–≥: `[middleware] Module inventory access denied for route /inventory`

### –¢–µ—Å—Ç 3: –í–∫–ª—é—á–µ–Ω–∏–µ –º–æ–¥—É–ª—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –≤ –¥–≤—É—Ö –æ–∫–Ω–∞—Ö (–∫–∞–∫ –≤ –¢–µ—Å—Ç–µ 1)
2. –í–∫–ª—é—á–∏—Ç–µ –º–æ–¥—É–ª—å "SMS-–∫–∞–º–ø–∞–Ω–∏–∏" (sms)

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –í —Å–∞–π–¥–±–∞—Ä–µ –ø–æ—è–≤–ª—è–µ—Ç—Å—è –Ω–æ–≤—ã–π —Ä–∞–∑–¥–µ–ª "SMS-—Å–æ–æ–±—â–µ–Ω–∏—è"
- ‚úÖ –°—Å—ã–ª–∫–∞ `/sms` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –¥–æ—Å—Ç—É–ø–Ω–æ–π

### –¢–µ—Å—Ç 4: –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
2. –û—Ç–∫—Ä–æ–π—Ç–µ –±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é
3. –ü–æ–ø—Ä–æ—Å–∏—Ç–µ –∞–¥–º–∏–Ω–∞ –æ—Ç–∫–ª—é—á–∏—Ç—å –º–æ–¥—É–ª—å, –ø–æ–∫–∞ –º–µ–Ω—é –æ—Ç–∫—Ä—ã—Ç–æ

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç:**
- ‚úÖ –ú–µ–Ω—é –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- ‚úÖ –û—Ç–∫–ª—é—á—ë–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏ –∏—Å—á–µ–∑–∞—é—Ç –∏–∑ —Å–ø–∏—Å–∫–∞

---

## Desktop –∏ Mobile

–í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞:
- ‚úÖ Desktop (Sidebar.tsx)
- ‚úÖ Mobile (MobileSidebar.tsx)
- ‚úÖ –û–±–∞ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –µ–¥–∏–Ω—É—é –ª–æ–≥–∏–∫—É —á–µ—Ä–µ–∑ `useFeatures` hook

---

## –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å

–í—Å–µ —Ç–µ–∫—Å—Ç—ã –∏ –ª–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç–∞—é—Ç –Ω–∞ –≤—Å–µ—Ö —è–∑—ã–∫–∞—Ö —Å–∏—Å—Ç–µ–º—ã:
- ‚úÖ –†—É—Å—Å–∫–∏–π (ru)
- ‚úÖ –ò–≤—Ä–∏—Ç (he)

–ü–µ—Ä–µ–≤–æ–¥—ã –±–µ—Ä—É—Ç—Å—è –∏–∑:
- `MODULES` –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (`modules-config.ts`)
- –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö (`useLanguage` hook)

---

## –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

- **Supabase Realtime**: –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã `organizations`
- **React Query**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—ç—à–µ–º –∏ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è
- **Next.js Middleware**: –ó–∞—â–∏—Ç–∞ —Ä–æ—É—Ç–æ–≤ –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

- **Realtime –ø–æ–¥–ø–∏—Å–∫–∞**: –°–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
- **Cleanup**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
- **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ**: 5 –º–∏–Ω—É—Ç (–µ—Å–ª–∏ –Ω–µ—Ç realtime –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π)

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ Middleware –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–Ω–µ–ª—å–∑—è –æ–±–æ–π—Ç–∏)
- ‚úÖ RLS –ø–æ–ª–∏—Ç–∏–∫–∏ Supabase –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `organizations`
- ‚úÖ –î–≤–æ–π–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: middleware + client-side

---

## Troubleshooting

### Realtime –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –í–∫–ª—é—á–µ–Ω –ª–∏ Realtime –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã `organizations` –≤ Supabase
2. –ï—Å—Ç—å –ª–∏ –¥–æ—Å—Ç—É–ø –∫ WebSocket –≤ –±—Ä–∞—É–∑–µ—Ä–µ (DevTools ‚Üí Network ‚Üí WS)

**–†–µ—à–µ–Ω–∏–µ:**
```sql
-- –í Supabase SQL Editor
ALTER PUBLICATION supabase_realtime ADD TABLE organizations;
```

### –ú–æ–¥—É–ª—å –Ω–µ –∏—Å—á–µ–∑–∞–µ—Ç –∏–∑ —Å–∞–π–¥–±–∞—Ä–∞

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –û—Ç–∫—Ä—ã—Ç–∞ –ª–∏ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞ (–∏—â–∏—Ç–µ –ª–æ–≥–∏ `[useOrganization] Real-time update received`)
2. –û–±–Ω–æ–≤–∏–ª—Å—è –ª–∏ –∫—ç—à React Query

**–†–µ—à–µ–Ω–∏–µ:**
- –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É (–∫—ç—à –ø—Ä–æ—Ç—É—Ö)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `staleTime` –≤ `useOrganization` (—Å–µ–π—á–∞—Å 5 –º–∏–Ω—É—Ç)

### Middleware –Ω–µ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç

**–ü—Ä–æ–≤–µ—Ä—å—Ç–µ:**
1. –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –º–∞–ø–ø–∏–Ω–≥ —Ä–æ—É—Ç–æ–≤ –≤ middleware
2. –ï—Å—Ç—å –ª–∏ –¥–∞–Ω–Ω—ã–µ `features.modules` –≤ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –≤ Supabase:
  ```sql
  SELECT id, name, features FROM organizations WHERE id = 'your-org-id';
  ```
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ `features.modules` —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ –∏–º–µ–µ—Ç —Ñ–æ—Ä–º–∞—Ç `{ "payments": true, "inventory": false, ... }`

---

## –ö–æ–º–º–∏—Ç –∏ –¥–µ–ø–ª–æ–π

### –ö–æ–º–º–∏—Ç
```bash
git add -A
git commit -m "feat(trinity): real-time module access control"
git push origin main
```

### –î–µ–ø–ª–æ–π
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π —á–µ—Ä–µ–∑ Vercel GitHub Integration

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
# –ü–æ—Å–ª–µ –¥–µ–ø–ª–æ—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–µ—Ä—Å–∏—é
curl https://yourdomain.com/api/health
```

---

## –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫

- [x] Real-time –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —á–µ—Ä–µ–∑ Supabase Realtime
- [x] Middleware –∑–∞—â–∏—Ç–∞ —Ä–æ—É—Ç–æ–≤
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Sidebar (desktop)
- [x] –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ MobileSidebar (mobile)
- [x] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏ –º–æ–¥—É–ª—è
- [x] –ú–Ω–æ–≥–æ—è–∑—ã—á–Ω–æ—Å—Ç—å (—Ä—É—Å—Å–∫–∏–π/–∏–≤—Ä–∏—Ç)
- [x] –†–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è owner + staff
- [x] –°–∫—Ä—ã—Ç–∏–µ —Ä–∞–∑–¥–µ–ª–æ–≤ –≤ —Å–∞–π–¥–±–∞—Ä–µ
- [x] –ó–∞—â–∏—Ç–∞ –ø—Ä—è–º—ã—Ö —Å—Å—ã–ª–æ–∫
- [x] –ö–æ–º–º–∏—Ç –∏ –ø—É—à –≤ main

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –¥–µ–ø–ª–æ—é
**–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:** 2026-02-26
